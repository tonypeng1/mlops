<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://madewithml.com/tagifai/train/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>train - A Language MLOps Project</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "train";
        var mkdocs_page_input_path = "tagifai/train.md";
        var mkdocs_page_url = "/tagifai/train/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> A Language MLOps Project
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">workflows</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../main/">main</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">tagifai</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../data/">data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../evaluate/">evaluate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../predict/">predict</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">train</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">A Language MLOps Project</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>tagifai &raquo;</li><li>train</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">

<a id="tagifai.train"></a>
    <div class="doc doc-contents first">

      <h2 id="tagifai.train--model-training"><strong>Model Training</strong></h2>
<h3 id="tagifai.train--1-in-train-function">1. üèùÔ∏è  <strong>In <code>train</code> function:</strong></h3>
<blockquote>
<ol>
<li>
<p>Set random seed so that the same sequence of random numbers is generated every time
<code>random.random()</code> or <code>np.random.rand()</code> is run.</p>
</li>
<li>
<p>Use <code>df.sample(fract=1).reset_index(drop=True)</code> (randomly sample rows from a Panda dataframe)
to suffle 100% of the rows of <code>df</code> (do not keep the old index).</p>
</li>
<li>
<p>(in <code>data.preprocess()</code>) First preprocess the <code>df</code>:</p>
<blockquote>
<ol>
<li>
<p>Feature engineering: Merge column <code>title</code> and <code>description</code> to form a new column <code>text</code>.</p>
</li>
<li>
<p>Clean text:</p>
<ul>
<li>Change to lower case</li>
<li>Remove stopwords</li>
<li>Add spacing between objects to be filtered</li>
<li>Remove non alphanumeric chars (only use A-Za-z0-9)</li>
<li>Remove multiple spaces</li>
<li>Strip white space at the ends</li>
<li>Remove links</li>
<li>Stemming</li>
</ul>
</li>
<li>
<p>Replace out of scope labels (not in the accepted label list) with "other".</p>
</li>
<li>
<p>Replace labels whose occurrences are less than a certain frequency with "other".
</p>
</li>
</ol>
</blockquote>
</li>
<li>
<p>Initiate an instance of <code>LabelEncoder</code> first, and use its <code>.fit()</code> methosd to fit each unique
label to an index, and assign to instance attributes of <code>.class_to_index</code> and <code>.index_to_class</code>.
Finally return the instance.</p>
</li>
<li>
<p>Change <code>text</code> column to a numpy array, encode the <code>tag</code> column using <code>.encode()</code>, and
train-test split the <code>df</code> to 70% training data, 15% validation data, and 15% test data
(<code>stratify = y</code>).</p>
</li>
<li>
<p>Construct <code>test</code> and decoded labels back to a dataframe of test data.</p>
</li>
<li>
<p>Initiate an instance of <code>TfidfVectorizer()</code> with the optimized <code>analyzer</code> = <code>char_wb</code>
(the input text is tokenized into charater n-gram within word boundaries, which are defined as
the edges of word tokens or the spaces between words) and the <code>ngram_range = (2, 6)</code>.</p>
</li>
<li>
<p>Use vectorizer to <code>.fit_transform()</code> <code>X_train</code> (resulting in 668x27096 sparse matrix of type
<code>numpy.float64</code>) and to <code>vectorizer.fransform()</code> <code>X_val</code> and <code>X_test</code>.</p>
</li>
<li>
<p>From <code>imblearn.over_sampling</code> import <code>RandomOverSample()</code> to randomly sample the minority
classes (with replacement) from <code>X_train</code> and <code>y_train</code> and add samples back to the class until
all classes have the same number of samples (<code>X_over</code>, <code>y_over</code>).</p>
</li>
<li>
<p>Initiate a model instance of <code>SGDClassifier</code>. Set <code>max_iter</code> = 1. But iterate through ecpoches
using <code>range(arg.num_epochs)</code> (= 100). Each time <code>model.fit(X_over, y_over)</code> is called the model
iterate once.</p>
</li>
<li>
<p>Use <code>log_loss()</code> to calculate the cross-entropy loss between <code>y_train</code> and <code>model.predict_proba(X_train)</code>
(= <code>train_loss</code>) and between <code>y_val</code> and <code>model.predict_proba(X_val)</code> for each epoch.</p>
</li>
<li>
<p>Use <code>mlflow.log_metrics({})</code> to log <code>train_loss</code> and <code>val_loss</code>.</p>
</li>
<li>
<p>After 100 iterations, use the final model to <code>.predict(X_val)</code> and <code>.predict_proba(X_val)</code>.
Inspect the predicted label's probability of each sample, and find the 1st quartile probability
(using <code>np.quantile(data, q=0.25)</code>).</p>
</li>
<li>
<p>Find the index of the <code>other</code> class (= 3), use the model to predict (<code>.predict_proba()</code>) <code>X_test</code>'s
probability (e.g., ([0.05, 0.87, 0.05, 0.03])). If the predicted label's probability is smaller
than the threshold, change the prediction to <code>3</code> (<code>others</code>), and save as the final prediction (= <code>y_pred</code>).</p>
</li>
<li>
<p>Use <code>precision_recall_fscore_support(y_true, y_pred, average="weighted")</code> to calculate metric values.
Here <code>weighted</code> means to calculate metrics for each label, and find their average weighted by support
(= the number of occurrences of each class in <code>y_true</code>).</p>
</li>
<li>
<p>Also use the same function with <code>average=None</code> to calculate the scores for each class.</p>
</li>
<li>
<p>Use <code>snorkel.slicing</code>'s <code>@slicing_function()</code> decorator to define two slicing functions:
<code>nlp_cnn()</code> (NLP projects that use convolution) and <code>short_text()</code> (project with combined title and
description with less than 8 words).</p>
</li>
<li>
<p>Then use <code>PandasSFApplier()</code> to apply these two slicing functions to <code>df</code>. This function returns
numpy record array: <code>slices = rec.array([(0, 0) (not true for both), (1, 0) (true for nlo_cnn), ...,
(0, 1) (true for short_text), ..., (0, 0)], dtype=[("nlp_cnn", "&lt;i8"), ("short_text", "&lt;i8")])</code>.
<code>slices["nlp_cnn"]</code> lists all values in the first value of a tuple, and <code>slices["short_text"]</code> lists
all values in the second value of a tuple.</p>
</li>
<li>
<p>Change <code>slices["short_text"]</code> (array([0, 0, ..., 1, 0 , ...])) to <code>.astype(bool)</code> to a mask, and
apply it to <code>y_true</code> and <code>y_pred</code> (using <code>y_true[mask]</code> and <code>y_pred[mask]</code>), then use
<code>precision_recall_fscore_support()</code> with <code>average = "micro"</code> to calculate metric scores (part of
<code>performance</code>).</p>
</li>
<li>
<p>Finally, <code>train.train()</code> returns <code>args</code>, <code>label_encoder</code>, <code>vectorizer</code>, <code>model</code>, and <code>performance</code>
</p>
</li>
</ol>
</blockquote>
<h3 id="tagifai.train--2-use-get_data_splits-to-split-data-in-dataget_data_split-module">2. ‚õ©Ô∏è  <strong>Use <code>get_data_splits</code> to split data (in <code>data.get_data_split</code> module):</strong></h3>
<blockquote>
<ul>
<li>Training split (e.g., 70%) to train the model<blockquote>
<p>Here the model has access to both inputs and outputs to optimize its internal weights.</p>
</blockquote>
</li>
<li>Validation split (e.g., 15%) to determine model performance after each training loop
(epoch)<blockquote>
<p>Model does not use the outputs to optimize its weights but instead, the output is used
to optimize training hyperparameters such as the <code>learning_rate</code>, <code>analyzer</code>, <code>ngram_max_range</code>, etc.
(see <code>main.py/optimize</code>).</p>
</blockquote>
</li>
<li>Test split (e.g., 15%) to perform a one-time assessment of the model.<blockquote>
<p>Our best measure of how the model may behave on new, unseen data.</p>
</blockquote>
</li>
</ul>
</blockquote>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h2 id="tagifai.train.objective" class="doc doc-heading">
<code class="highlight language-python"><span class="n">objective</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Objective function for optimization trials.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>args</strong> (<code>Namespace</code>) ‚Äì arguments to use for training.</p></li>
            <li><p><strong>df</strong> (<code>pd.DataFrame</code>) ‚Äì data for training.</p></li>
            <li><p><strong>trial</strong> (<code>optuna.trial._trial.Trial</code>) ‚Äì optimization trial.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p><code>float</code> ‚Äì metric value to be used for optimization.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tagifai/train.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">trial</span><span class="o">.</span><span class="n">_trial</span><span class="o">.</span><span class="n">Trial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Objective function for optimization trials.</span>
<span class="sd">    Args:</span>
<span class="sd">        args (Namespace): arguments to use for training.</span>
<span class="sd">        df (pd.DataFrame): data for training.</span>
<span class="sd">        trial (optuna.trial._trial.Trial, optional): optimization trial.</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: metric value to be used for optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parameters to tune</span>
    <span class="n">args</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;analyzer&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="s2">&quot;char_wb&quot;</span><span class="p">])</span>
    <span class="n">args</span><span class="o">.</span><span class="n">ngram_max_range</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;ngram_max_range&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">power_t</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_uniform</span><span class="p">(</span><span class="s2">&quot;power_t&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Train &amp; evaluate</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="n">trial</span><span class="p">)</span>

    <span class="c1"># Set additional attributes</span>
    <span class="n">overall_performance</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">][</span><span class="s2">&quot;overall&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">overall_performance</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">])</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="tagifai.train.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Train model on data.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><strong>args</strong> (<code>Namespace</code>) ‚Äì parameter arguments to use for training.</p></li>
            <li><p><strong>df</strong> (<code>pd.DataFrame</code>) ‚Äì data for training.</p></li>
            <li><p><strong>trial</strong> (<code>optuna.trial._trial.Trial</code>) ‚Äì optimization trial. Defaults to None.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Exceptions:</th>
      <td class="field-body">
        <ul class="first simple">
            <li><p><code>optuna.TrialPruned</code> ‚Äì early stopping of trial if it's performing poorly.</p></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
        <ul class="first simple">
          <li><p><code>Dict</code> ‚Äì artifacts from the run.</p></li>
        </ul>
    </td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tagifai/train.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">trial</span><span class="o">.</span><span class="n">_trial</span><span class="o">.</span><span class="n">Trial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train model on data.</span>
<span class="sd">    Args:</span>
<span class="sd">        args (Namespace): parameter arguments to use for training.</span>
<span class="sd">        df (pd.DataFrame): data for training.</span>
<span class="sd">        trial (optuna.trial._trial.Trial, optional): optimization trial. Defaults to None.</span>
<span class="sd">    Raises:</span>
<span class="sd">        optuna.TrialPruned: early stopping of trial if it&#39;s performing poorly.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict: artifacts from the run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">set_seeds</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span> <span class="n">args</span><span class="o">.</span><span class="n">subset</span><span class="p">]</span>  <span class="c1"># None = all samples</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">stem</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">min_freq</span><span class="p">)</span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_data_splits</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">y_test</span><span class="p">)})</span>

    <span class="c1"># Tf-idf</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span>
        <span class="n">analyzer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ngram_max_range</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># char n-grams</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_val</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Oversample</span>
    <span class="n">oversample</span> <span class="o">=</span> <span class="n">RandomOverSampler</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">X_over</span><span class="p">,</span> <span class="n">y_over</span> <span class="o">=</span> <span class="n">oversample</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SGDClassifier</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="n">eta0</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">power_t</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">power_t</span><span class="p">,</span>
        <span class="n">warm_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_over</span><span class="p">,</span> <span class="n">y_over</span><span class="p">)</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_val</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;train_loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;val_loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Log</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trial</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="c1"># Pruning (for optimization in next section)</span>
        <span class="k">if</span> <span class="n">trial</span><span class="p">:</span>  <span class="c1"># pragma: no cover, optuna pruning</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>

    <span class="c1"># Threshold</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="n">y_prob</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)],</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># Q1</span>

    <span class="c1"># Evaluation</span>
    <span class="n">other_index</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">custom_predict</span><span class="p">(</span><span class="n">y_prob</span><span class="o">=</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">other_index</span><span class="p">)</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">test_df</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
        <span class="s2">&quot;label_encoder&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">,</span>
        <span class="s2">&quot;vectorizer&quot;</span><span class="p">:</span> <span class="n">vectorizer</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../predict/" class="btn btn-neutral float-left" title="predict"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../utils/" class="btn btn-neutral float-right" title="utils">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tonypeng1/mlops" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../predict/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../utils/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
